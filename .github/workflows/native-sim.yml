name: Native Sim Tests

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  native-sim:
    runs-on: ubuntu-latest
    env:
      ZEPHYR_TOOLCHAIN_VARIANT: zephyr

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build gcc-multilib libc6-dev-i386 python3-pip

      - name: Install Zephyr SDK
        run: |
          cd $HOME
          wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.17.0/zephyr-sdk-0.17.0_linux-x86_64.tar.xz
          tar xf zephyr-sdk-0.17.0_linux-x86_64.tar.xz
          rm zephyr-sdk-0.17.0_linux-x86_64.tar.xz
          $HOME/zephyr-sdk-0.17.0/setup.sh -t arm-zephyr-eabi -h -c
          echo "ZEPHYR_SDK_INSTALL_DIR=$HOME/zephyr-sdk-0.17.0" >> $GITHUB_ENV

      - name: Initialize west workspace
        run: |
          pip install --user west
          python3 -m west init -l .
          python3 -m west update
          python3 -m west zephyr-export
          topdir=$(python3 -m west topdir)
          echo "ZEPHYR_BASE=${topdir}/zephyr" >> "$GITHUB_ENV"
          pip install --user -r "${topdir}/zephyr/scripts/requirements-base.txt"

      - name: Build persist_state native_sim tests
        run: |
          source ${ZEPHYR_BASE}/zephyr-env.sh
          west build -b native_sim -p always tests/persist_state --build-dir build/tests/persist_state
        shell: bash

      - name: Run persist_state native_sim tests
        run: |
          source ${ZEPHYR_BASE}/zephyr-env.sh
          west build -t run --build-dir build/tests/persist_state
        shell: bash

      - name: Build supervisor native_sim tests
        run: |
          source ${ZEPHYR_BASE}/zephyr-env.sh
          west build -b native_sim -p always tests/supervisor --build-dir build/tests/supervisor
        shell: bash

      - name: Run supervisor native_sim tests
        run: |
          source ${ZEPHYR_BASE}/zephyr-env.sh
          west build -t run --build-dir build/tests/supervisor
        shell: bash

      - name: Build MISRA hardware suite (compile check)
        run: |
          source ${ZEPHYR_BASE}/zephyr-env.sh
          west build -p always tests/unit/misra_stage1 -b nucleo_l053r8 --build-dir build/tests/unit/misra_stage1
        shell: bash
